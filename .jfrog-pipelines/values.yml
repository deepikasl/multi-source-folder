serviceName: distribution
metadata:
  releaseBundleType: v2

inputs:
  pipeline:
    configuration:
      integrations:
        - deepikaArt
      retentionPolicy:
        maxAgeDays: 90
        minRuns: 10

  integrations:
    artifactory: deepikaArt
    distribution: deepikaDist

  resources:
    build_info:
      buildName: go_app
      buildNumber: 14

    release_bundle:
      name: deepika_demo_rb_1
      version: v1.0.0

    signed_bundle:
      name: deepika_demo_rb_1
      version: v1.0.0

    promoted_bundle:
      name: deepika_demo_rb_1
      version: v1.0.0

    distribution_rules:
      serviceName: "*"
      siteName: "*"
      cityName: "*"
      countryCodes:
        - "CN"

configurations:
  steps:
    create_release_bundle:
      onStart:
        - echo "create_release_bundle"
        - fileSpecFileName="createReleaseBundlePayload.json"
        - fileSpec='{"builds":[]}'
        - aqlTemplate="{\"name\":\"$res_build_info_buildName\",\"number\":\"$res_build_info_buildNumber\",\"repository_key\":\"tasks-build-info\"}"
        - buildInfoQuery=$(echo {} | jq --argjson json "$aqlTemplate" '$json')
        - fileSpec=$(echo $fileSpec | jq --argjson json "$buildInfoQuery" '.builds += [ $json ]')
        - echo "$fileSpec"
        - echo "$fileSpec" | jq . > "$step_tmp_dir/$fileSpecFileName"
      onExecute:
        - jfrog rbc --builds=$step_tmp_dir/$fileSpecFileName --signing-key=pipelines-rb-gpg-key deepika_demo_rb_1 1.0.0
      onFailure:
        - echo "onFailure"
      onSuccess:
        - echo "onSuccess"

    sign_release_bundle:
      onStart:
        - echo "onStart"
      onExecute:
        - echo "onExecute"
      onFailure:
        - echo "onFailure"
      onSuccess:
        - echo "onSuccess"

    promote_release_bundle:
      onStart:
        - echo "create_release_bundle"
      onExecute:
        - echo "onExecute"
        - jfrog rbp --signing-key=deepika-pipelines-rb deepika_demo_rb 1.0.0
      onFailure:
        - echo "onFailure"
      onSuccess:
        - echo "onSuccess"

    distribute_to_edge:
      onStart:
        - fileSpecFileName="createReleaseBundlePayload.json"
        - fileSpec='{"distribution_rules":[]}'
        - aqlTemplate="{\"site_name\":\"\",\"city_name\":\"\",\"country_codes\":\"*\"}"
        - buildInfoQuery=$(echo {} | jq --argjson json "$aqlTemplate" '$json')
        - fileSpec=$(echo $fileSpec | jq --argjson json "$buildInfoQuery" '.distribution_rules += [ $json ]')
        - echo "$fileSpec"
        - echo "$fileSpec" | jq . > "$step_tmp_dir/$fileSpecFileName"
      onExecute:
        - jfrog rbd --dist-rules=$step_tmp_dir/$fileSpecFileName deepika_demo_rb_1 1.0.0
      onFailure:
        - echo "onFailure"
      onSuccess:
        - echo "onSuccess"
        
controls:
  create_release_bundle:
    runtime: auto
    enabled: true

  sign_release_bundle:
    runtime: auto
    enabled: false

  promote_release_bundle:
    runtime: auto
    enabled: true
