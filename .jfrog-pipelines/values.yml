serviceName: distribution
metadata:
  releaseBundleType: v2

inputs:
  pipeline:
    configuration:
      integrations:
        - deepikaArt
      retentionPolicy:
        maxAgeDays: 90
        minRuns: 10

  integrations:
    artifactory: deepikaArt
    distribution: deepikaDist

  resources:
    build_info:
      buildName: go_app
      buildNumber: 14

    release_bundle:
      name: deepika_demo_rb
      version: v1.0.0

    signed_bundle:
      name: deepika_demo_rb
      version: v1.0.0

    promoted_bundle:
      name: deepika_demo_rb
      version: v1.0.0

    distribution_rules:
      serviceName: "*"
      siteName: "*"
      cityName: "*"
      countryCodes:
        - "CN"
        - "GB"

configurations:
  steps:
    create_release_bundle:
      onStart:
        - echo "create_release_bundle"
        - fileSpecFileName="createReleaseBundlePayload.json"
        - fileSpec='{"builds":[]}'
        - aqlTemplate="{\"name\":\"$res_build_info_buildName\",\"number\":\"$res_build_info_buildNumber\",\"repository_key\":\"tasks-build-info\"}"
        - buildInfoQuery=$(echo {} | jq --argjson json "$aqlTemplate" '$json')
        - fileSpec=$(echo $fileSpec | jq --argjson json "$buildInfoQuery" '.builds += [ $json ]')
        - echo "$fileSpec"
        - echo "$fileSpec" | jq . > "$step_tmp_dir/$fileSpecFileName"
      onExecute:
        - jfrog rbc --builds=$step_tmp_dir/$fileSpecFileName --signing-key=deepika-pipelines-rb deepika_demo_rb 1.0.0
      onFailure:
        - echo "onFailure"
      onSuccess:
        - echo "onSuccess"

    sign_release_bundle:
      onStart:
        - echo "onStart"
      onExecute:
        - echo "onExecute"
      onFailure:
        - echo "onFailure"
      onSuccess:
        - echo "onSuccess"

    promote_release_bundle:
      onStart:
        - echo "create_release_bundle"
      onExecute:
        - echo "onExecute"
        - jfrog rbp --signing-key=deepika-pipelines-rb deepika_demo_rb 1.0.0
      onFailure:
        - echo "onFailure"
      onSuccess:
        - echo "onSuccess"

    distribute_to_edge:
      onStart:
        - distributionRuleResourceObject="{\"service_name\": \"$res_distribution_rules_serviceName\", \"site_name\": \"$res_distribution_rules_siteName\", \"city_name\": \"$res_distribution_rules_cityName\", \"country_codes\": []}"
        - local countryCodesLen=$(find_resource_variable "$distributionRuleResourceName" countryCodes_len)
        - |
          if [ ! -z "$res_distribution_rules_countryCodes_len" ] && [ $res_distribution_rules_countryCodes_len -gt 0 ]; then
            for (( j=0; j<$res_distribution_rules_countryCodes_len; j++ )); do
              code=$res_distribution_rules_countryCodes_$j
              distributionRuleResourceObject=$(echo $distributionRuleResourceObject | jq --arg code "$code" '.country_codes += [ $code ]')
            done
          fi
        - body=$(echo $body | jq --argjson json "$distributionRuleResourceObject" '.distribution_rules += [ $json ]')
        - echo "$body"
        - echo \"\$body\" | jq '.' > \$step_tmp_dir/distribution_payload
      onExecute:
        - jfrog rbd --dist-rules=$step_tmp_dir/distribution_payload deepika_demo_rb 1.0.0
      onFailure:
        - echo "onFailure"
      onSuccess:
        - echo "onSuccess"
        
controls:
  create_release_bundle:
    runtime: auto
    enabled: true

  sign_release_bundle:
    runtime: auto
    enabled: false

  promote_release_bundle:
    runtime: auto
    enabled: true
