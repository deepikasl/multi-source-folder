valuesFilePath: api_values.yml
# Template Variables

# Names
{{ $serviceName := .Values.metadata.serviceName }}
{{ $gitResName := print $serviceName "_git_source" }}
{{ $buildInfoResultResName := print $serviceName "_build_result" }}
{{ $buildInfoResName := print $serviceName "_build_info" }}
{{ $pipelineName := print $serviceName "_build" }}
{{ $rootDirectory := ternary (print "/" .Values.configurations.sourceDirectory) "" (not (eq "" .Values.configurations.sourceDirectory)) }}

{{ $isControlsAvailable := default false .Values.controls }}
{{ $isTriggerByAvailable := default false (and $isControlsAvailable .Values.controls.triggerBy) }}
{{ $isQualityAvailable := default false (and $isControlsAvailable (eq .Values.controls.codeQuality.enabled true)) }}
{{ $isPublishAvailable := default false (and $isControlsAvailable (eq .Values.controls.publish.enabled true)) }}
{{ $isLintAvailable := default false (and $isControlsAvailable (eq .Values.controls.lint.enabled true)) }}
{{ $isClamScanAvailable := default false (and $isControlsAvailable (eq .Values.controls.clamScan.enabled true)) }}
{{ $isGitTriggerEnabled := default false (and $isTriggerByAvailable (eq .Values.controls.triggerBy.sourceRepository true)) }}

# -----------------------------------------------------------------
# Reusable templates
# These are resolved using 'template' thus indentation is important
# -----------------------------------------------------------------
{{ $resultResources := dict "buildInfoResultResName" $buildInfoResultResName }}
{{ $templateParams := merge $resultResources (dict "values" .Values "gitResName" $gitResName "rootDirectory" $rootDirectory) }}

# Git repo resource
{{ define "res.gitRepo.config" }}
  {{ range $key, $value := .Values.inputs.sourceRepository }}
  {{ $isObject := or (eq $key "files") (eq $key "branches") (eq $key "pullRequestSourceBranches") (eq $key "pullRequestTargetBranches") (eq $key "tags") (eq $key "buildOn") (eq $key "cancelPendingRunsOn") (eq $key "pin") }}
  {{ if (eq $isObject false )}}
      {{ $key }}: {{ $value }}
  {{ else }}
      {{ $key }}:
  {{ range $depthKey, $depthValue := $value }}
        {{ $depthKey }}: {{ $depthValue }}
  {{ end }}
  {{ end }}
  {{ end }}
{{ end }}

{{ define "pipeline.config.integrations" }}
  {{ $ := . }}
            {{- range $int := .Values.inputs.pipeline.configuration.integrations }}
            - name: {{ $int }}
            {{- end }}
{{ end }}

{{ define "pipeline.config.environmentVariables" }}
  {{ $ := . }}
            {{ range $key, $value := .Values.inputs.pipeline.configuration.environmentVariables }}
            {{ $key }}: {{ $value }}
            {{ end }}
{{ end }}

{{ define "pipeline.config.retentionPolicy" }}
  {{ $ := . }}
            {{ range $key, $value := .Values.inputs.pipeline.configuration.retentionPolicy }}
            {{ $key }}: {{ $value }}
            {{ end }}
{{ end }}

# Steps shared onExecute template
{{ define "step.shared.onExecute.command" }}
  {{ $ := . }}
            {{ if ( and ($.conf) ($.conf.onExecute) ) }}
            {{- range $cmd := $.conf.onExecute }}
            - {{ $cmd }}
            {{- end }}
            {{ else if $.default}}
            - {{ $.default }}
            {{ end }}
{{ end }}

# Steps shared onStart template
{{ define "step.shared.onStart.command" }}
  {{ $ := . }}
            {{ if $.conf }}
            {{- range $cmd := $.conf.onStart }}
            - {{ $cmd }}
            {{- end }}
            {{ end }}
{{ end }}

# Steps shared onSuccess template
{{ define "step.shared.onSuccess.command" }}
  {{ $ := . }}
            {{ if $.conf }}
            {{- range $cmd := $.conf.onSuccess }}
            - {{ $cmd }}
            {{- end }}
            {{ end }}
{{ end }}

# Steps shared onFailure template
{{ define "step.shared.onFailure.command" }}
  {{ $ := . }}
            {{ if $.conf }}
            {{- range $cmd := $.conf.onFailure }}
            - {{ $cmd }}
            {{- end }}
            {{ end }}
{{ end }}

# build step
{{ define "step.build.onExecute" }}
  {{ $ := . }}
  {{ $ := set $ "conf" $.values.configurations.steps.build }}
  {{ $ := set $ "default" "npm run build" }}
            - cd ${res_{{ $.gitResName }}_resourcePath}
            {{ template "step.shared.onExecute.command" $ }}
{{ end }}

{{ define "step.build.onStart" }}
  {{ $ := . }}
  {{ $ := set $ "conf" $.values.configurations.steps.build }}
            - cd ${res_{{ $.gitResName }}_resourcePath}
            {{ template "step.shared.onStart.command" $ }}
{{ end }}

{{ define "step.build.onSuccess" }}
  {{ $ := . }}
  {{ $ := set $ "conf" $.values.configurations.steps.build }}
            - cd ${res_{{ $.gitResName }}_resourcePath}
            {{ template "step.shared.onSuccess.command" $ }}
{{ end }}

{{ define "step.build.onFailure" }}
  {{ $ := . }}
  {{ $ := set $ "conf" $.values.configurations.steps.build }}
            - cd ${res_{{ $.gitResName }}_resourcePath}
            {{ template "step.shared.onFailure.command" $ }}
{{ end }}

# lint step
{{ define "step.lint.onExecute" }}
  {{ $ := . }}
  {{ $ := set $ "conf" $.values.configurations.steps.lint }}
  {{ $ := set $ "default" "npm run lint" }}
            - cd ${res_{{ $.gitResName }}_resourcePath}
            {{ template "step.shared.onExecute.command" $ }}
{{ end }}

{{ define "step.lint.onStart" }}
  {{ $ := . }}
  {{ $ := set $ "conf" $.values.configurations.steps.lint }}
            - cd ${res_{{ $.gitResName }}_resourcePath}
            {{ template "step.shared.onStart.command" $ }}
{{ end }}

{{ define "step.lint.onSuccess" }}
  {{ $ := . }}
  {{ $ := set $ "conf" $.values.configurations.steps.lint }}
            - cd ${res_{{ $.gitResName }}_resourcePath}
            {{ template "step.shared.onSuccess.command" $ }}
{{ end }}

{{ define "step.lint.onFailure" }}
  {{ $ := . }}
  {{ $ := set $ "conf" $.values.configurations.steps.lint }}
            - cd ${res_{{ $.gitResName }}_resourcePath}
            {{ template "step.shared.onFailure.command" $ }}
{{ end }}

# code quality step
{{ define "step.codeQuality.onExecute" }}
  {{ $ := . }}
  {{ $ := set $ "conf" $.values.configurations.steps.codeQuality }}
  {{ $ := set $ "default" "npm run clean" }}
            - cd ${res_{{ $.gitResName }}_resourcePath}
            {{ template "step.shared.onExecute.command" $ }}
{{ end }}

{{ define "step.codeQuality.onStart" }}
  {{ $ := . }}
  {{ $ := set $ "conf" $.values.configurations.steps.codeQuality }}
            - cd ${res_{{ $.gitResName }}_resourcePath}
            {{ template "step.shared.onStart.command" $ }}
{{ end }}

{{ define "step.codeQuality.onSuccess" }}
  {{ $ := . }}
  {{ $ := set $ "conf" $.values.configurations.steps.codeQuality }}
            - cd ${res_{{ $.gitResName }}_resourcePath}
            {{ template "step.shared.onSuccess.command" $ }}
{{ end }}

{{ define "step.codeQuality.onFailure" }}
  {{ $ := . }}
  {{ $ := set $ "conf" $.values.configurations.steps.codeQuality }}
            - cd ${res_{{ $.gitResName }}_resourcePath}
            {{ template "step.shared.onFailure.command" $ }}
{{ end }}

# sonar scan step
{{ define "step.sonarScan.onExecute" }}
  {{ $ := . }}
  {{ $ := set $ "conf" $.values.configurations.steps.sonarScan }}
            - cd ${res_{{ $.gitResName }}_resourcePath}
            {{ template "step.shared.onExecute.command" $ }}
{{ end }}

{{ define "step.sonarScan.onStart" }}
  {{ $ := . }}
  {{ $ := set $ "conf" $.values.configurations.steps.sonarScan }}
            - cd ${res_{{ $.gitResName }}_resourcePath}
            {{ template "step.shared.onStart.command" $ }}
{{ end }}

{{ define "step.sonarScan.onSuccess" }}
  {{ $ := . }}
  {{ $ := set $ "conf" $.values.configurations.steps.sonarScan }}
            - cd ${res_{{ $.gitResName }}_resourcePath}
            {{ template "step.shared.onSuccess.command" $ }}
{{ end }}

{{ define "step.sonarScan.onFailure" }}
  {{ $ := . }}
  {{ $ := set $ "conf" $.values.configurations.steps.sonarScan }}
            - cd ${res_{{ $.gitResName }}_resourcePath}
            {{ template "step.shared.onFailure.command" $ }}
{{ end }}

# clam scan step
{{ define "step.clamScan.onExecute" }}
  {{ $ := . }}
  {{ $ := set $ "conf" $.values.configurations.steps.clamScan }}
            - cd ${res_{{ $.gitResName }}_resourcePath}
            {{ template "step.shared.onExecute.command" $ }}
{{ end }}

{{ define "step.clamScan.onStart" }}
  {{ $ := . }}
  {{ $ := set $ "conf" $.values.configurations.steps.clamScan }}
            - cd ${res_{{ $.gitResName }}_resourcePath}
            {{ template "step.shared.onStart.command" $ }}
{{ end }}

{{ define "step.clamScan.onSuccess" }}
  {{ $ := . }}
  {{ $ := set $ "conf" $.values.configurations.steps.clamScan }}
            - cd ${res_{{ $.gitResName }}_resourcePath}
            {{ template "step.shared.onSuccess.command" $ }}
{{ end }}

{{ define "step.clamScan.onFailure" }}
  {{ $ := . }}
  {{ $ := set $ "conf" $.values.configurations.steps.clamScan }}
            - cd ${res_{{ $.gitResName }}_resourcePath}
            {{ template "step.shared.onFailure.command" $ }}
{{ end }}

# publish step
{{ define "step.publish.onExecute" }}
  {{ $ := . }}
  {{ $ := set $ "conf" $.values.configurations.steps.publish }}
  {{ $ := set $ "resultResource" $.buildInfoResultResName }}
  {{ $ := set $ "default" "npm publish" }}
            - cd ${res_{{ $.gitResName }}_resourcePath}
            {{ template "step.shared.onExecute.command" $ }}
            - write_output {{ $.resultResource }} "buildName=$JFROG_CLI_BUILD_NAME"
            - write_output {{ $.resultResource }} "buildNumber=$JFROG_CLI_BUILD_NUMBER"
{{ end }}

{{ define "step.publish.onSuccess" }}
  {{ $ := . }}
  {{ $ := set $ "conf" $.values.configurations.steps.publish }}
            - cd ${res_{{ $.gitResName }}_resourcePath}
            {{ template "step.shared.onSuccess.command" $ }}
{{ end }}

{{ define "step.publish.onFailure" }}
  {{ $ := . }}
  {{ $ := set $ "conf" $.values.configurations.steps.publish }}
            - cd ${res_{{ $.gitResName }}_resourcePath}
            {{ template "step.shared.onFailure.command" $ }}
{{ end }}
# -----------------------------------------------------------------

# Resource definitions
resources:
  - name: {{ $gitResName }}
    type: GitRepo
    configuration:
      {{ template "res.gitRepo.config" . }}

  - name: {{ $buildInfoResultResName }}
    type: PropertyBag
    configuration:
      timestamp: ''

  - name: {{ $buildInfoResName }}
    type: BuildInfo
    configuration:
      sourceArtifactory: {{ .Values.inputs.integrations.artifactory }}
      buildName: ''
      buildNumber: ''

# Pipeline definition
pipelines:
  - name: {{ $pipelineName }}
    configuration:
      jfrogCliVersion: {{ default 2 .Values.metadata.jfrogCliVersion }}
      integrations:
        {{ template "pipeline.config.integrations" . }}
      environmentVariables:
        readOnly:
          {{ template "pipeline.config.environmentVariables" . }}
      retentionPolicy:
        {{ template "pipeline.config.retentionPolicy" . }}

      # Setting nodePool
      {{ if .Values.metadata.nodePool }}
      nodePool: {{ .Values.metadata.nodePool }}
      {{ end }}

    steps:
      - name: {{ .Values.metadata.serviceName }}_build
        type: Bash
        configuration:
          affinityGroup: {{ .Values.metadata.serviceName }}
          inputResources:
            - name: {{ $gitResName }}
              trigger: {{ $isGitTriggerEnabled }}
          runtime:
            type: image
            image:
              {{ if (eq .Values.controls.build.runtime "custom") }}
              custom:
                {{ range $key, $value := .Values.configurations.steps.build.runtime.custom }}
                {{ $key }}: {{ $value }}
                {{ end }}
              {{ else }}
              auto:
                language: node
                versions:
                  {{- range $version := .Values.configurations.steps.build.runtime.versions }}
                  - {{ $version }}
                  {{- end }}
              {{ end }}
        execution:
          {{ if .Values.configurations.steps.build.onStart }}
          onStart:
            {{ template "step.build.onStart" $templateParams }}
          {{ end }}
          onExecute:
            {{ template "step.build.onExecute" $templateParams }}
          onSuccess:
            {{ template "step.build.onSuccess" $templateParams }}
          onFailure:
            {{ template "step.build.onFailure" $templateParams }}
      {{ if $isLintAvailable }}
      - name: {{ .Values.metadata.serviceName }}_lint
        type: Bash
        configuration:
          affinityGroup: {{ .Values.metadata.serviceName }}
          runtime:
            type: image
            image:
              {{ if (eq .Values.controls.lint.runtime "custom") }}
              custom:
                {{ range $key, $value := .Values.configurations.steps.lint.runtime.custom }}
                {{ $key }}: {{ $value }}
                {{ end }}
              {{ else }}
              auto:
                language: node
                versions:
                  {{- range $version := .Values.configurations.steps.lint.runtime.versions }}
                  - {{ $version }}
                  {{- end }} 
              {{ end }}
          inputSteps:
            - name: {{ .Values.metadata.serviceName }}_build
              status:
                - success
        execution:
          onExecute:
            {{ template "step.lint.onExecute" $templateParams }}
          onSuccess:
            {{ template "step.lint.onSuccess" $templateParams }}
          onFailure:
            {{ template "step.lint.onFailure" $templateParams }}
      {{ end }}

      {{ if $isQualityAvailable }}
      - name: {{ .Values.metadata.serviceName }}_quality
        type: Bash
        configuration:
          affinityGroup: {{ .Values.metadata.serviceName }}_quality
          integrations:
           - name: {{ .Values.inputs.integrations.artifactory }}
          inputResources:
            - name: {{ $gitResName }}
              trigger: {{ $isGitTriggerEnabled }}
          inputSteps:
            - name: {{ .Values.metadata.serviceName }}_build
          runtime:
            type: image
            image:
              {{ if (eq .Values.controls.codeQuality.runtime "custom") }}
              custom:
                {{ range $key, $value := .Values.configurations.steps.codeQuality.runtime.custom }}
                {{ $key }}: {{ $value }}
                {{ end }}
              {{ else }}
              auto:
                language: node
                versions:
                  {{- range $version := .Values.configurations.steps.codeQuality.runtime.versions }}
                  - {{ $version }}
                  {{- end }} 
              {{ end }}
        execution:
          onStart:
            {{ template "step.codeQuality.onStart" $templateParams }}
          onExecute:
            {{ template "step.codeQuality.onExecute" $templateParams }}
          onSuccess:
            {{ template "step.codeQuality.onSuccess" $templateParams }}
          onFailure:
            {{ template "step.codeQuality.onFailure" $templateParams }}

      - name: {{ .Values.metadata.serviceName }}_sonar_scan
        type: Bash
        configuration:
          affinityGroup: {{ .Values.metadata.serviceName }}_quality
          runtime:
            type: image
            image:
              {{ if (eq .Values.controls.sonarScan.runtime "custom") }}
              custom:
                {{ range $key, $value := .Values.configurations.steps.sonarScan.runtime.custom }}
                {{ $key }}: {{ $value }}
                {{ end }}
              {{ else }}
              auto:
                language: node
                versions:
                  {{- range $version := .Values.configurations.steps.sonarScan.runtime.versions }}
                  - {{ $version }}
                  {{- end }} 
              {{ end }}
          integrations:
           - name: {{ .Values.inputs.integrations.artifactory }}
           - name: {{ .Values.inputs.integrations.sonar }}
          inputSteps:
            - name: {{ .Values.metadata.serviceName }}_quality
          inputResources:
            - name: {{ $gitResName }}
              trigger: {{ $isGitTriggerEnabled }}
        execution:
          onStart:
            {{ template "step.sonarScan.onStart" $templateParams }}
          onExecute:
            {{ template "step.sonarScan.onExecute" $templateParams }}
          onSuccess:
            {{ template "step.sonarScan.onSuccess" $templateParams }}
          onFailure:
            {{ template "step.sonarScan.onFailure" $templateParams }}
      {{ end }}

      {{ if $isClamScanAvailable }}
      - name: {{ .Values.metadata.serviceName }}_clam_scan
        type: Bash
        configuration:
          affinityGroup: {{ .Values.metadata.serviceName }}
          runtime:
            type: image
            image:
              {{ if (eq .Values.controls.clamScan.runtime "custom") }}
              custom:
                {{ range $key, $value := .Values.configurations.steps.clamScan.runtime.custom }}
                {{ $key }}: {{ $value }}
                {{ end }}
              {{ else }}
              auto:
                language: node
                versions:
                  {{- range $version := .Values.configurations.steps.clamScan.runtime.versions }}
                  - {{ $version }}
                  {{- end }} 
              {{ end }}
          inputResources:
            - name: {{ $gitResName }}
              trigger: {{ $isGitTriggerEnabled }}
          inputSteps:
            - name: {{ .Values.metadata.serviceName }}_build
        execution:
          onStart:
            {{ template "step.clamScan.onStart" $templateParams }}
          onExecute:
            {{ template "step.clamScan.onExecute" $templateParams }}
          onSuccess:
            {{ template "step.clamScan.onSuccess" $templateParams }}
          onFailure:
            {{ template "step.clamScan.onFailure" $templateParams }}
      {{ end }}

      {{ if $isPublishAvailable }}
      - name: {{ .Values.metadata.serviceName }}_publish
        type: Bash
        configuration:
          affinityGroup: {{ .Values.metadata.serviceName }}
          runtime:
            type: image
            image:
              {{ if (eq .Values.controls.publish.runtime "custom") }}
              custom:
                {{ range $key, $value := .Values.configurations.steps.publish.runtime.custom }}
                {{ $key }}: {{ $value }}
                {{ end }}
              {{ else }}
              auto:
                language: node
                versions:
                  {{- range $version := .Values.configurations.steps.publish.runtime.versions }}
                  - {{ $version }}
                  {{- end }} 
              {{ end }}
          inputSteps:
            - name: {{ .Values.metadata.serviceName }}_build
              status:
                - success
          outputResources:
            - name: {{ $buildInfoResultResName }}
            - name: {{ $buildInfoResName }}
        execution:
          onExecute:
            {{ template "step.publish.onExecute" $templateParams }}
          onSuccess:
            {{ template "step.publish.onSuccess" $templateParams }}
          onFailure:
            {{ template "step.publish.onFailure" $templateParams }}
      {{ end }}
