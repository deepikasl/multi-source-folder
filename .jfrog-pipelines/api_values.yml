metadata:
  serviceName:  api

inputs:
  pipeline:
    configuration:
      integrations:
        - deepikaArt
        - mySlack
      environmentVariables:
        foo: bar
        test: env
      retentionPolicy:
        maxAgeDays: 30
        minRuns: 10

  sourceRepository:
    path: deepikasl/jfrog_pipelines
    gitProvider: deepikaGithub
    branches:
      include: master

  integrations:
    artifactory: deepikaArt
    sonar: deepikaSonar

configurations:

  sourceDirectory: ''

  steps:
    build:
      runtime:
        versions:
          - "16.10.0"
      # onStart:
      #   - echo "onStart"
      onExecute:
        - echo "onExecute"
        - |
          RT_SERVER=server \
          RT_URL=$repo21 \
          RT_USER=$int_entplus_deployer_user \
          RT_API_KEY=$int_entplus_deployer_apikey \
          IMG_NAME=$apiImageName \
          PIPELINES_CORE_VERSION=$PIPELINES_CORE_VERSION \
          IMG_TAG=$RELEASE_VERSION \
          RT_REGISTRY=entplus.jfrog.io/${RT_DOCKER_REPO} \
          MICRO_BUILD_IMAGE=$res_node16BuildImage_imageName:$res_node16BuildImage_imageTag \
          BASE_RUN_IMAGE=$res_node16MicroRunImage_imageName:$res_node16MicroRunImage_imageTag \
          ./buildApi.sh "${res_apiGit_resourcePath}"
      onFailure:
        - echo "onFailure"
      onSuccess:
        - echo "onSuccess"

    codeQuality:
      runtime:
        versions:
          - "16.10.0"
      onStart:
        - echo "onStart"
      onExecute:
        - echo "onExecute"
      onFailure:
        - echo "onFailure"
      onSuccess:
        - echo "onSuccess"


    sonarScan:
      runtime:
        custom:
          registry: deepikaArt
          name: stg-repo.jfrog.info/pipelines-docker/pipelines-u16go
          tag: 0.9.1
      onStart:
        - echo "onStart"
      onExecute:
        - echo "onExecute"
      onFailure:
        - echo "onFailure"
      onSuccess:
        - echo "onSuccess"

    publish:
      runtime:
        versions:
          - "16.10.0"
      onExecute:
        - echo "onExecute"
      onFailure:
        - echo "onFailure"
      onSuccess:
        - echo "onSuccess"


    clamScan:
      runtime:
        custom:
          registry: deepikaArt
          name: stg-repo.jfrog.info/pipelines-docker/pipelines-u16go
          tag: 0.9.1
      onStart:
        - echo "onStart"
      onExecute:
        - echo "onExecute"
      onFailure:
        - echo "onFailure"
      onSuccess:
        - echo "onSuccess"
        
controls:

  build:
    runtime: auto

  codeQuality:
    enabled: true
    runtime: auto

  sonarScan:
    runtime: custom

  clamScan:
    runtime: custom

  publish:
    enabled: true
    runtime: auto

  triggerBy:
    sourceRepository: true
